# Homing and adjustment routines for Itsy Bitsy


[gcode_macro _SAFE_Z_MOVE]
gcode:
  QUERY_ENDSTOPS
  {% set last = printer['query_endstops'].last_query|default({}) %}
  {% set z_triggered = last.get('z') %}
  {% if z_triggered is none %}
    {action_respond_info("Z endstop state unknown (no prior query).")}
    G0 Z5 F1200
  {% elif z_triggered %}
    G0 Z-5 F1200
  {% else %}
    G0 Z5 F1200
  {% endif %}

[homing_override]
axes: xyz
set_position_z: 0
gcode:
   QUERY_ENDSTOPS
   G90
   _SAFE_Z_MOVE

  {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}

  {% if home_all or 'X' in params %}
    _HOME_X
  {% endif %}

  {% if home_all or 'Y' in params %}
    _HOME_Y
  {% endif %}

  {% if home_all or 'Z' in params %}
    _HOME_Z
  {% endif %}

  {% set homed = printer.toolhead.homed_axes|default("") %}
  {% if 'X' in homed and 'Y' in homed and 'Z' in homed %}
    G0 X45 Y45 F4000
  {% else %}
    {action_respond_info("Skipping XY move: not all axes homed (homed_axes=" ~ homed ~ ").")}
  {% endif %}
 
#####################################################################
# Sensorless Homing
#####################################################################

[gcode_macro _HOME_X]
description: Sensorless home X with current swap, verification, and safe park
gcode:
  # Preserve current modal state
  SAVE_GCODE_STATE NAME=_HOME_X_STATE
  G90

  # Tunables
  {% set HOME_CUR = 0.60 %}
  {% set PARK_X = 95.5 %}
  {% set driver = printer.configfile.settings['tmc2209 stepper_x'] %}
  {% set RUN_CUR = driver.run_current|float %}
  
  # Swap to homing current (and optional sensitivity)
  SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CUR}

  # Short dwell to ensure driver flags settle
  G4 P800

  # Home X
  G28 X

  # Verify homed
  {% set homed = printer.toolhead.homed_axes|default("") %}
  {% if 'X' not in homed %}
    {action_respond_info("X failed to home; restoring currents and state.")}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CUR}

    RESTORE_GCODE_STATE NAME=_HOME_X_STATE
  {% else %}
    # Clamp park target to valid axis range
    {% set xmin = printer.toolhead.axis_minimum.x|default(0.0) %}
    {% set xmax = printer.toolhead.axis_maximum.x|default(200.0) %}
    {% set margin = 1.0 %}
    {% set safe_x = PARK_X %}
    {% if safe_x < xmin + margin %}{% set safe_x = xmin + margin %}{% endif %}
    {% if safe_x > xmax - margin %}{% set safe_x = xmax - margin %}{% endif %}

    {action_respond_info("X homed; parking at X=" ~ safe_x ~ " (limits " ~ xmin ~ "–" ~ xmax ~ ").")}
    G1 X{safe_x} F1200

    # Restore run current (and optional sensitivity)
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CUR}
    RESTORE_GCODE_STATE NAME=_HOME_X_STATE
  {% endif %}

[gcode_macro _HOME_Y]
description: Sensorless home Y with current swap, verification, and safe park
gcode:
  # Preserve current modal state
  SAVE_GCODE_STATE NAME=_HOME_Y_STATE
  G90

  # Tunables
  {% set HOME_CUR = 0.60 %}
  {% set PARK_Y = 79.0 %}
  {% set driver = printer.configfile.settings['tmc2209 stepper_y'] %}
  {% set RUN_CUR = driver.run_current|float %}

  # Swap to homing current (and optional sensitivity)
  SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CUR}
  # Short dwell to ensure driver flags settle
  G4 P800

  # Home Y
  G28 Y

  # Verify homed
  {% set homed = printer.toolhead.homed_axes|default("") %}
  {% if 'Y' not in homed %}
    {action_respond_info("Y failed to home; restoring currents and state.")}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CUR}
    RESTORE_GCODE_STATE NAME=_HOME_Y_STATE
  {% else %}
    # Clamp park target to valid axis range
    {% set ymin = printer.toolhead.axis_minimum.y|default(0.0) %}
    {% set ymax = printer.toolhead.axis_maximum.y|default(200.0) %}
    {% set margin = 1.0 %}
    {% set safe_y = PARK_Y %}
    {% if safe_y < ymin + margin %}{% set safe_y = ymin + margin %}{% endif %}
    {% if safe_y > ymax - margin %}{% set safe_y = ymax - margin %}{% endif %}

    {action_respond_info("Y homed; parking at Y=" ~ safe_y ~ " (limits " ~ ymin ~ "–" ~ ymax ~ ").")}
    G1 Y{safe_y} F1200

    # Restore run current (and optional sensitivity)
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CUR}
    RESTORE_GCODE_STATE NAME=_HOME_Y_STATE
  {% endif %}

[gcode_macro _HOME_Z]
description: Safe Z homing that releases the Z endstop, homes Z, verifies homed, and lifts to a clamped safe height.
gcode:
  # Preserve current modal state so we don't surprise other macros or prints
  SAVE_GCODE_STATE NAME=_HOME_Z_STATE

  # Always use absolute positioning for homing and the post-home lift
  G90

  # Move safely away from the endstop/bed before homing
  _SAFE_Z_MOVE

  # Fresh endstop read (optional, keeps logs informative)
  QUERY_ENDSTOPS

  # Perform Z homing
  G28 Z

  # Verify Z reported as homed before proceeding
  {% set homed = printer.toolhead.homed_axes|default("") %}
  {% if 'Z' not in homed %}
    {action_respond_info("Z failed to home; skipping post-home lift.")}
    RESTORE_GCODE_STATE NAME=_HOME_Z_STATE
  {% else %}
    # Compute a safe clearance target:
    # - At least 0.5mm above axis minimum
    # - No higher than 1mm below axis maximum
    # - Prefer 5mm if within limits
    {% set amin = printer.toolhead.axis_minimum.z|default(0.0) %}
    {% set amax = printer.toolhead.axis_maximum.z|default(10.0) %}
    {% set target = 5.0 %}
    {% set min_clear = amin + 0.5 %}
    {% set max_clear = amax - 1.0 %}
    {% set safe_z = target %}
    {% if safe_z < min_clear %}
      {% set safe_z = min_clear %}
    {% endif %}
    {% if safe_z > max_clear %}
      {% set safe_z = max_clear %}
    {% endif %}

    {action_respond_info("Post-home Z lift to " ~ safe_z ~ "mm (limits: " ~ amin ~ "–" ~ amax ~ ").")}
    G1 Z{safe_z} F1200

    RESTORE_GCODE_STATE NAME=_HOME_Z_STATE
  {% endif %}