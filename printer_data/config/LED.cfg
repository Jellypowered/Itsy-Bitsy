[delayed_gcode PRETTY_LEDs]
initial_duration: 1
gcode:
    SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=0.0 BLUE=1.0 WHITE=0.0
    SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=1.0
    SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=1.0

[gcode_macro BORING_LEDs]
gcode:
    SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0 #Anthead Logo LED
    SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0 #Left Nozzle LED
    SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0 #Right Nozzle LED

# Safe, %-free LED loop (CHASE, BREATH, RAINBOW, TRAIN)
# Start with:
#   LED_LOOP_START_CHASE
#   LED_LOOP_START_BREATH
#   LED_LOOP_START_RAINBOW
#   LED_LOOP_START_TRAIN
# Stop with:
#   LED_LOOP_STOP

[gcode_macro LED_LOOP_CTRL]
variable_running: 0
variable_step: 0
variable_speed_ms: 150
variable_palette: 0   ; 0=NEON,1=PASTEL,2=COOL,3=WARM
variable_mode: 0      ; 0=CHASE,1=BREATH,2=RAINBOW,3=TRAIN
variable_breath_dir: 1
variable_led_count: 3
gcode:
  ; controller state container

[gcode_macro LED_LOOP_START_CHASE]
gcode:
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=mode VALUE=0
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=palette VALUE=0
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE=150
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE=0
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  UPDATE_DELAYED_GCODE ID=led_loop DURATION=0.001

[gcode_macro LED_LOOP_START_BREATH]
gcode:
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=mode VALUE=1
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=palette VALUE=1
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE=80
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE=0
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=breath_dir VALUE=1
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  UPDATE_DELAYED_GCODE ID=led_loop DURATION=0.001

[gcode_macro LED_LOOP_START_RAINBOW]
gcode:
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=mode VALUE=2
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=palette VALUE=2
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE=200
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE=0
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  UPDATE_DELAYED_GCODE ID=led_loop DURATION=0.001

[gcode_macro LED_LOOP_START_TRAIN]
gcode:
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=mode VALUE=3
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=palette VALUE=0
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE=120
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE=0
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  UPDATE_DELAYED_GCODE ID=led_loop DURATION=0.001

[gcode_macro LED_LOOP_STOP]
gcode:
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=0
  BORING_LEDs

[delayed_gcode led_loop]
gcode:
    {% set ctrl = printer['gcode_macro LED_LOOP_CTRL'].variables %}
    {% set running = ctrl.running|int %}
    {% if running == 1 %}
      {% set step = ctrl.step|int %}
      {% set speed = ctrl.speed_ms|int %}
      {% set palette_idx = ctrl.palette|int %}
      {% set mode_idx = ctrl.mode|int %}
      {% set N = ctrl.led_count|default(3)|int %}

      {# Build palettes (numeric-indexed) #}
      {% if palette_idx == 0 %}
        {% set palette = [
          [1.0,0.0,1.0,0.0],
          [1.0,0.2,0.0,0.0],
          [0.0,1.0,0.2,0.0]
        ] %}
      {% elif palette_idx == 1 %}
        {% set palette = [
          [1.0,0.8,0.9,0.0],
          [0.8,1.0,0.9,0.0],
          [0.9,0.9,1.0,0.0]
        ] %}
      {% elif palette_idx == 2 %}
        {% set palette = [
          [0.0,0.6,1.0,0.0],
          [0.0,1.0,1.0,0.0],
          [0.0,0.5,0.8,0.0]
        ] %}
      {% elif palette_idx == 3 %}
        {% set palette = [
          [1.0,0.5,0.0,0.0],
          [1.0,0.7,0.2,0.0],
          [1.0,0.3,0.0,0.0]
        ] %}
      {% else %}
        {% set palette = [
          [1.0,0.0,1.0,0.0],
          [0.0,1.0,1.0,0.0],
          [1.0,1.0,0.0,0.0]
        ] %}
      {% endif %}

      {# CHASE mode: light one LED at a time #}
      {% if mode_idx == 0 %}
        {% set div = (step // N) %}
        {% set rem = step - (div * N) %}
        {% set idx = rem + 1 %}
        {% set plen = palette|length %}
        {% set pdiv = (step // plen) %}
        {% set pidx = step - (pdiv * plen) %}
        {% set col = palette[pidx] %}
        {% set r_val = col[0] %}
        {% set g_val = col[1] %}
        {% set b_val = col[2] %}
        {% set w_val = col[3] %}

        {% for i in range(1, N+1) %}
          {% if i == idx %}
            {{ "SET_LED LED=sb_leds INDEX=" ~ i|string ~ " RED=" ~ (r_val|round(3)|string) ~ " GREEN=" ~ (g_val|round(3)|string) ~ " BLUE=" ~ (b_val|round(3)|string) ~ " WHITE=" ~ (w_val|round(3)|string) }}
          {% else %}
            {{ "SET_LED LED=sb_leds INDEX=" ~ i|string ~ " RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000" }}
          {% endif %}
        {% endfor %}

        {% set next_step = step + 1 %}

      {# BREATH mode: ramp 0..100 and back #}
      {% elif mode_idx == 1 %}
        {% set dir = ctrl.breath_dir|default(1)|int %}
        {% set i_val = step %}
        {% set scale = (i_val / 100.0) %}
        {% set base = palette[0] %}
        {% set r_val = (scale * base[0]) %}
        {% set g_val = (scale * base[1]) %}
        {% set b_val = (scale * base[2]) %}
        {% set w_val = (scale * base[3]) %}

        {% for iidx in range(1, N+1) %}
          {{ "SET_LED LED=sb_leds INDEX=" ~ iidx|string ~ " RED=" ~ (r_val|round(3)|string) ~ " GREEN=" ~ (g_val|round(3)|string) ~ " BLUE=" ~ (b_val|round(3)|string) ~ " WHITE=" ~ (w_val|round(3)|string) }}
        {% endfor %}

        {% set step_inc = 5 %}
        {% if dir == 1 %}
          {% set cand = step + step_inc %}
          {% if cand > 100 %}
            {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=breath_dir VALUE=-1" }}
            {% set next_step = 100 %}
          {% else %}
            {% set next_step = cand %}
          {% endif %}
        {% else %}
          {% set cand = step - step_inc %}
          {% if cand < 0 %}
            {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=breath_dir VALUE=1" }}
            {% set next_step = 0 %}
          {% else %}
            {% set next_step = cand %}
          {% endif %}
        {% endif %}

      {# RAINBOW mode: cycle palette on all LEDs #}
      {% elif mode_idx == 2 %}
        {% set plen = palette|length %}
        {% set pdiv = (step // plen) %}
        {% set pidx = step - (pdiv * plen) %}
        {% set col = palette[pidx] %}
        {% set r_val = col[0] %}
        {% set g_val = col[1] %}
        {% set b_val = col[2] %}
        {% set w_val = col[3] %}

        {% for iidx in range(1, N+1) %}
          {{ "SET_LED LED=sb_leds INDEX=" ~ iidx|string ~ " RED=" ~ (r_val|round(3)|string) ~ " GREEN=" ~ (g_val|round(3)|string) ~ " BLUE=" ~ (b_val|round(3)|string) ~ " WHITE=" ~ (w_val|round(3)|string) }}
        {% endfor %}

        {% set next_step = step + 1 %}

      {# TRAIN mode: head + short trailing dim LED #}
      {% elif mode_idx == 3 %}
        {% set divh = (step // N) %}
        {% set remh = step - (divh * N) %}
        {% set head = remh + 1 %}
        {% set plen = palette|length %}
        {% set pdiv = (step // plen) %}
        {% set pidx = step - (pdiv * plen) %}
        {% set col = palette[pidx] %}
        {% set r_h = col[0] %}
        {% set g_h = col[1] %}
        {% set b_h = col[2] %}
        {% set w_h = col[3] %}
        {% if head < N %}
          {% set head_next = head + 1 %}
        {% else %}
          {% set head_next = 1 %}
        {% endif %}

        {% for iidx in range(1, N+1) %}
          {% if iidx == head %}
            {{ "SET_LED LED=sb_leds INDEX=" ~ iidx|string ~ " RED=" ~ (r_h|round(3)|string) ~ " GREEN=" ~ (g_h|round(3)|string) ~ " BLUE=" ~ (b_h|round(3)|string) ~ " WHITE=" ~ (w_h|round(3)|string) }}
          {% elif iidx == head_next %}
            {{ "SET_LED LED=sb_leds INDEX=" ~ iidx|string ~ " RED=" ~ ((r_h*0.5)|round(3)|string) ~ " GREEN=" ~ ((g_h*0.5)|round(3)|string) ~ " BLUE=" ~ ((b_h*0.5)|round(3)|string) ~ " WHITE=" ~ ((w_h*0.5)|round(3)|string) }}
          {% else %}
            {{ "SET_LED LED=sb_leds INDEX=" ~ iidx|string ~ " RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000" }}
          {% endif %}
        {% endfor %}

        {% set next_step = step + 1 %}

      {% else %}
        {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=0" }}
        {% set next_step = step %}
      {% endif %}

      {# persist next step and reschedule #}
      {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE=" ~ next_step|string }}
      {% set dur_s = (speed / 1000.0) %}
      {% if dur_s < 0.02 %}
        {% set dur_s = 0.02 %}
      {% endif %}
      {{ "UPDATE_DELAYED_GCODE ID=led_loop DURATION=" ~ (dur_s|round(3)|string) }}
    {% endif %}