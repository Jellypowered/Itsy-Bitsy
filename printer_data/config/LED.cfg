[delayed_gcode STARTUP_LEDs]
initial_duration: 1
gcode:
    SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=0.0 BLUE=1.0 WHITE=0.0
    SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=1.0
    SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=1.0

[gcode_macro BORING_LEDs]
gcode:
    SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0 #Anthead Logo LED
    SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0 #Left Nozzle LED
    SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0 #Right Nozzle LED

# Safe LED effects (no risky template constructs). 
# Supports: CHASE (smooth fade), BREATH, RAINBOW, TRAIN

# Usage (examples):
#   LED_LOOP_START MODE=CHASE SPEED_MS=40
#   LED_LOOP_START MODE=BREATH SPEED_MS=120
#   LED_LOOP_STOP

[gcode_macro LED_LOOP_CTRL]
# controller state (numeric only)
variable_running: 0
variable_speed_ms: 120
variable_fade_steps: 5
variable_led_count: 3

# per-effect state variables (must be declared so SET_GCODE_VARIABLE can set them)
variable_breath_step: 0
variable_rain_step: 0
variable_train_step: 0
variable_fade_index: 0

gcode:
  ; controller state container

[gcode_macro LED_LOOP_STOP]
gcode:
  # stop loop and restore BORING_LEDs, wait for buffer to clear
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=0
  STARTUP_LEDs
  M400

[gcode_macro LED_LOOP_START]
# Unified start macro (safe mapping). MODE is a word: CHASE, BREATH, RAINBOW, TRAIN
# SPEED_MS optional (default set below)
gcode:
    {% set mode = params.MODE|default('CHASE')|upper %}
    {% set speed = params.SPEED_MS|default(120)|int %}
    # set speed variable
    SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE={speed}
    # start the requested mode by invoking its start macro (plain G-code line emitted)
    {% if mode == 'CHASE' %}
    LED_LOOP_START_CHASE
    {% elif mode == 'BREATH' %}
    LED_LOOP_START_BREATH
    {% elif mode == 'RAINBOW' %}
    LED_LOOP_START_RAINBOW
    {% elif mode == 'TRAIN' %}
    LED_LOOP_START_TRAIN
    {% else %}
    # fallback to CHASE
    LED_LOOP_START_CHASE
    {% endif %}

#
# START macros (plain-gcode starters). These set running=1 and schedule the first delayed_gcode step.
#
[gcode_macro LED_LOOP_START_CHASE]
gcode:
  # configure fade steps if you want to change from default
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=fade_steps VALUE=5
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  UPDATE_DELAYED_GCODE ID=led_chase_f0 DURATION=0.001

[gcode_macro LED_LOOP_START_BREATH]
gcode:
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  # breath starts from low
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=breath_step VALUE=0
  UPDATE_DELAYED_GCODE ID=led_breath_00 DURATION=0.001

[gcode_macro LED_LOOP_START_RAINBOW]
gcode:
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE=80
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=rain_step VALUE=0
  UPDATE_DELAYED_GCODE ID=led_rainbow_f0 DURATION=0.001

# --- Change the train starter to a slower default (you can override with SPEED_MS param) ---
[gcode_macro LED_LOOP_START_TRAIN]
gcode:
  # slower default so it looks like a train by default
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE=80
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=train_step VALUE=0
  UPDATE_DELAYED_GCODE ID=led_train_0 DURATION=0.001

#
# CHASE (smooth) implementation — fade between LED indices using fade_steps per transition.
# Structure: led_chase_f0 ... led_chase_f{(N*fade_steps)-1}
# We implement a small, deterministic scheme so templates remain simple and safe:
#
# Behavior (for 3 LEDs, fade_steps=5):
# - Sequence covers LED1 -> LED2 (5 substeps), LED2 -> LED3 (5), LED3 -> LED1 (5), repeat.
#
# Each delayed_gcode template checks running|int first and bails out early if stopped.
#

# We generate N * fade_steps templates (N=3, fade_steps=5 -> 15 templates).
# To keep the config readable and maintainable here we unroll them explicitly for fade_steps=5, N=3.

[delayed_gcode led_chase_f0]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED1 -> LED2, substep 1 (fade_steps=5)
  # brightness fractions: step 1 -> 0.2 / 0.8
  SET_LED LED=sb_leds INDEX=1 RED=0.800 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f1 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f1]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED1 -> LED2, substep 2 (40%)
  SET_LED LED=sb_leds INDEX=1 RED=0.600 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.400 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f2 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f2]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED1 -> LED2, substep 3 (60%)
  SET_LED LED=sb_leds INDEX=1 RED=0.400 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.600 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f3 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f3]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED1 -> LED2, substep 4 (80%)
  SET_LED LED=sb_leds INDEX=1 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.800 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f4 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f4]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED1 -> LED2, substep 5 (100% -> LED2)
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=1.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f5 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f5]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED2 -> LED3, substep 1
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.800 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f6 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f6]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED2 -> LED3, substep 2
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.600 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.400 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f7 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f7]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED2 -> LED3, substep 3
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.400 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.600 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f8 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f8]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED2 -> LED3, substep 4
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.800 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f9 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f9]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED2 -> LED3, substep 5 (100% LED3)
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=1.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f10 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f10]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED3 -> LED1, substep 1
  SET_LED LED=sb_leds INDEX=1 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.800 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f11 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f11]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED3 -> LED1, substep 2
  SET_LED LED=sb_leds INDEX=1 RED=0.400 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.600 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f12 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f12]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED3 -> LED1, substep 3
  SET_LED LED=sb_leds INDEX=1 RED=0.600 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.400 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f13 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f13]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED3 -> LED1, substep 4
  SET_LED LED=sb_leds INDEX=1 RED=0.800 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f14 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f14]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED3 -> LED1, substep 5 (back to LED1 full)
  SET_LED LED=sb_leds INDEX=1 RED=1.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  # loop back to first fade substep
  UPDATE_DELAYED_GCODE ID=led_chase_f0 DURATION=0.040
  {% endif %}

# Smooth BREATH — 41-step up/down chain (21 up / 20 down).
# Use SPEED_MS to set substep duration (ms). Example: LED_LOOP_START MODE=BREATH SPEED_MS=150

[delayed_gcode led_breath_00]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.00 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_01 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_01]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.05 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_02 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_02]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.10 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_03 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_03]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.15 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_04 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_04]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.20 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_05 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_05]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.25 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_06 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_06]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.30 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_07 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_07]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.35 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_08 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_08]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.40 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_09 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_09]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.45 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_10 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_10]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.50 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_11 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_11]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.55 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_12 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_12]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.60 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_13 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_13]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.65 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_14 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_14]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.70 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_15 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_15]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.75 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_16 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_16]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.80 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_17 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_17]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.85 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_18 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_18]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.90 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_19 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_19]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.95 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_20 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_20]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 1.00 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_21 DURATION={dur}
  {% endif %}

# Ramp down (mirror)...
[delayed_gcode led_breath_21]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.95 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_22 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_22]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.90 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_23 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_23]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.85 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_24 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_24]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.80 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_25 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_25]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.75 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_26 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_26]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.70 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_27 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_27]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.65 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_28 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_28]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.60 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_29 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_29]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.55 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_30 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_30]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.50 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_31 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_31]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.45 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_32 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_32]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.40 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_33 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_33]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.35 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_34 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_34]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.30 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_35 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_35]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.25 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_36 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_36]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.20 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_37 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_37]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.15 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_38 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_38]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.10 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_39 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_39]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.05 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_40 DURATION={dur}
  {% endif %}

[delayed_gcode led_breath_40]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  {% set scale = 0.00 %}
  {% set r1 = scale * 1.0 %}{% set g1 = scale * 0.0 %}{% set b1 = scale * 1.0 %}
  {% set r2 = scale * 0.0 %}{% set g2 = scale * 0.6 %}{% set b2 = scale * 1.0 %}
  {% set r3 = scale * 1.0 %}{% set g3 = scale * 1.0 %}{% set b3 = scale * 0.0 %}
  {% set r1s = r1|round(3) %}{% set g1s = g1|round(3) %}{% set b1s = b1|round(3) %}
  {% set r2s = r2|round(3) %}{% set g2s = g2|round(3) %}{% set b2s = b2|round(3) %}
  {% set r3s = r3|round(3) %}{% set g3s = g3|round(3) %}{% set b3s = b3|round(3) %}
  {% set dur = (printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int) / 1000.0 %}
  SET_LED LED=sb_leds INDEX=1 RED={r1s} GREEN={g1s} BLUE={b1s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED={r2s} GREEN={g2s} BLUE={b2s} WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED={r3s} GREEN={g3s} BLUE={b3s} WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_breath_00 DURATION={dur}
  {% endif %}

# Smooth Rainbow: 3 palette colors with 5 fade substeps each (15 templates total).
# Each template checks running first and reschedules to the next substep.
# Uses speed_ms from LED_LOOP_CTRL for substep timing:
#   LED_LOOP_START MODE=RAINBOW SPEED_MS=40

[delayed_gcode led_rainbow_f0]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # A->B substep 1 (A=magenta, B=green)
  SET_LED LED=sb_leds INDEX=1 RED=0.800 GREEN=0.200 BLUE=0.840 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.800 GREEN=0.200 BLUE=0.840 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.800 GREEN=0.200 BLUE=0.840 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f1 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f1]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # A->B substep 2
  SET_LED LED=sb_leds INDEX=1 RED=0.600 GREEN=0.400 BLUE=0.680 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.600 GREEN=0.400 BLUE=0.680 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.600 GREEN=0.400 BLUE=0.680 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f2 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f2]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # A->B substep 3
  SET_LED LED=sb_leds INDEX=1 RED=0.400 GREEN=0.600 BLUE=0.520 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.400 GREEN=0.600 BLUE=0.520 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.400 GREEN=0.600 BLUE=0.520 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f3 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f3]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # A->B substep 4
  SET_LED LED=sb_leds INDEX=1 RED=0.200 GREEN=0.800 BLUE=0.360 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.200 GREEN=0.800 BLUE=0.360 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.200 GREEN=0.800 BLUE=0.360 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f4 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f4]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # A->B arrive (B = green)
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=1.000 BLUE=0.200 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=1.000 BLUE=0.200 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=1.000 BLUE=0.200 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f5 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f5]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # B->C substep 1 (B=green, C=blue)
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.920 BLUE=0.360 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.920 BLUE=0.360 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=0.920 BLUE=0.360 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f6 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f6]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # B->C substep 2
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.840 BLUE=0.520 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.840 BLUE=0.520 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=0.840 BLUE=0.520 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f7 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f7]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # B->C substep 3
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.760 BLUE=0.680 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.760 BLUE=0.680 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=0.760 BLUE=0.680 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f8 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f8]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # B->C substep 4
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.680 BLUE=0.840 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.680 BLUE=0.840 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=0.680 BLUE=0.840 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f9 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f9]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # B->C arrive (C = blue)
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.600 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.600 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=0.600 BLUE=1.000 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f10 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f10]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # C->A substep 1 (C=blue, A=magenta)
  SET_LED LED=sb_leds INDEX=1 RED=0.200 GREEN=0.480 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.200 GREEN=0.480 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.200 GREEN=0.480 BLUE=1.000 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f11 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f11]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # C->A substep 2
  SET_LED LED=sb_leds INDEX=1 RED=0.400 GREEN=0.360 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.400 GREEN=0.360 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.400 GREEN=0.360 BLUE=1.000 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f12 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f12]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # C->A substep 3
  SET_LED LED=sb_leds INDEX=1 RED=0.600 GREEN=0.240 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.600 GREEN=0.240 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.600 GREEN=0.240 BLUE=1.000 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f13 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f13]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # C->A substep 4
  SET_LED LED=sb_leds INDEX=1 RED=0.800 GREEN=0.120 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.800 GREEN=0.120 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.800 GREEN=0.120 BLUE=1.000 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f14 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f14]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # C->A arrive (A = magenta)
  SET_LED LED=sb_leds INDEX=1 RED=1.000 GREEN=0.000 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=1.000 GREEN=0.000 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=1.000 GREEN=0.000 BLUE=1.000 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f0 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

# --- TRAIN chain remains but will use speed_ms for delay; default start sets speed_ms=300 ---
[delayed_gcode led_train_0]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=1.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_1 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_train_1]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.75 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.25 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_2 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_train_2]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.50 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.50 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_3 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_train_3]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.25 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.75 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_4 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}  

[delayed_gcode led_train_4]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=1.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_5 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}  

[delayed_gcode led_train_5]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=1.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_6 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %} 

[delayed_gcode led_train_6]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=1.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_7 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %} 

[delayed_gcode led_train_7]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.25 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.75 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_8 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}  

[delayed_gcode led_train_8]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.50 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.50 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_9 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}    

[delayed_gcode led_train_9]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.50 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.25 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_10 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}    

[delayed_gcode led_train_10]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.75 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_11 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}    

[delayed_gcode led_train_11]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=1.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_12 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}    

[delayed_gcode led_train_12]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=1.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_0 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}    

[gcode_macro THEATER_CTRL]
variable_running: 0
variable_speed_ms: 120
gcode:
  ; theater chase controller

[gcode_macro THEATER_START]
gcode:
  SET_GCODE_VARIABLE MACRO=THEATER_CTRL VARIABLE=speed_ms VALUE=120
  SET_GCODE_VARIABLE MACRO=THEATER_CTRL VARIABLE=running VALUE=1
  UPDATE_DELAYED_GCODE ID=theater_step0 DURATION=0.001

[gcode_macro THEATER_STOP]
gcode:
  SET_GCODE_VARIABLE MACRO=THEATER_CTRL VARIABLE=running VALUE=0
  BORING_LEDs
  M400

[delayed_gcode theater_step0]
gcode:
  {% if printer['gcode_macro THEATER_CTRL'].running|int == 1 %}
  # pattern: on, off, off
  SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=theater_step1 DURATION={printer['gcode_macro THEATER_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode theater_step1]
gcode:
  {% if printer['gcode_macro THEATER_CTRL'].running|int == 1 %}
  # pattern: off, on, off
  SET_LED LED=sb_leds INDEX=1 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=1.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=theater_step2 DURATION={printer['gcode_macro THEATER_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode theater_step2]
gcode:
  {% if printer['gcode_macro THEATER_CTRL'].running|int == 1 %}
  # pattern: off, off, on
  SET_LED LED=sb_leds INDEX=1 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=1.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=theater_step0 DURATION={printer['gcode_macro THEATER_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[gcode_macro LARSON_CTRL]
variable_running: 0
variable_speed_ms: 40
gcode:
  ; larson scanner controller

[gcode_macro LARSON_START]
gcode:
  # default substep duration ~40ms, change with SPEED_MS param by editing the variable before starting
  SET_GCODE_VARIABLE MACRO=LARSON_CTRL VARIABLE=speed_ms VALUE=40
  SET_GCODE_VARIABLE MACRO=LARSON_CTRL VARIABLE=running VALUE=1
  UPDATE_DELAYED_GCODE ID=larson_f0 DURATION=0.001

[gcode_macro LARSON_STOP]
gcode:
  SET_GCODE_VARIABLE MACRO=LARSON_CTRL VARIABLE=running VALUE=0
  BORING_LEDs
  M400

# We implement a short chain of substeps (example: 9 templates for a left-to-right and back sweep)
[delayed_gcode larson_f0]
gcode:
  {% if printer['gcode_macro LARSON_CTRL'].running|int == 1 %}
  # eye near LED1
  SET_LED LED=sb_leds INDEX=1 RED=1.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.500 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=larson_f1 DURATION={printer['gcode_macro LARSON_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode larson_f1]
gcode:
  {% if printer['gcode_macro LARSON_CTRL'].running|int == 1 %}
  # moving toward LED2
  SET_LED LED=sb_leds INDEX=1 RED=0.600 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=1.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.300 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=larson_f2 DURATION={printer['gcode_macro LARSON_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode larson_f2]
gcode:
  {% if printer['gcode_macro LARSON_CTRL'].running|int == 1 %}
  # eye at LED2 center
  SET_LED LED=sb_leds INDEX=1 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=1.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=larson_f3 DURATION={printer['gcode_macro LARSON_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode larson_f3]
gcode:
  {% if printer['gcode_macro LARSON_CTRL'].running|int == 1 %}
  # moving toward LED3
  SET_LED LED=sb_leds INDEX=1 RED=0.100 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.600 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=1.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=larson_f4 DURATION={printer['gcode_macro LARSON_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode larson_f4]
gcode:
  {% if printer['gcode_macro LARSON_CTRL'].running|int == 1 %}
  # reflect back (mirror)
  SET_LED LED=sb_leds INDEX=1 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=1.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=larson_f3 DURATION={printer['gcode_macro LARSON_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[gcode_macro TEMPBAR_CTRL]
variable_running: 0
variable_sample_ms: 500
gcode:
  ; temp bar controller

[gcode_macro TEMPBAR_START]
gcode:
  SET_GCODE_VARIABLE MACRO=TEMPBAR_CTRL VARIABLE=running VALUE=1
  UPDATE_DELAYED_GCODE ID=tempbar_step DURATION=0.001

[gcode_macro TEMPBAR_STOP]
gcode:
  SET_GCODE_VARIABLE MACRO=TEMPBAR_CTRL VARIABLE=running VALUE=0
  BORING_LEDs
  M400

[delayed_gcode tempbar_step]
gcode:
  {% if printer['gcode_macro TEMPBAR_CTRL'].running|int == 1 %}
  {% set t = printer['extruder'].temperature|float %}
  {# Choose thresholds that map temperature to 0..3 lit LEDs #}
  {% if t >= 200.0 %}
    # 3 LEDs lit
    SET_LED LED=sb_leds INDEX=1 RED=1.000 GREEN=0.000 BLUE=0.000 WHITE=0.000
    SET_LED LED=sb_leds INDEX=2 RED=1.000 GREEN=0.000 BLUE=0.000 WHITE=0.000
    SET_LED LED=sb_leds INDEX=3 RED=1.000 GREEN=0.000 BLUE=0.000 WHITE=0.000
  {% elif t >= 140.0 %}
    # 2 LEDs lit
    SET_LED LED=sb_leds INDEX=1 RED=1.000 GREEN=0.000 BLUE=0.000 WHITE=0.000
    SET_LED LED=sb_leds INDEX=2 RED=1.000 GREEN=0.000 BLUE=0.000 WHITE=0.000
    SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000
  {% elif t >= 80.0 %}
    # 1 LED lit
    SET_LED LED=sb_leds INDEX=1 RED=1.000 GREEN=0.000 BLUE=0.000 WHITE=0.000
    SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000
    SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000
  {% else %}
    # none
    SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000
    SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000
    SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000
  {% endif %}

  UPDATE_DELAYED_GCODE ID=tempbar_step DURATION={printer['gcode_macro TEMPBAR_CTRL'].sample_ms|int / 1000.0}
  {% endif %}