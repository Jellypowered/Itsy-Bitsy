[delayed_gcode PRETTY_LEDs]
initial_duration: 1
gcode:
    SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=0.0 BLUE=1.0 WHITE=0.0
    SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=1.0
    SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=1.0

[gcode_macro BORING_LEDs]
gcode:
    SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0 #Anthead Logo LED
    SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0 #Left Nozzle LED
    SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0 #Right Nozzle LED

# Safe LED loop (avoids '%' and complex Jinja constructs)
# Start macros are plain G-code:
#   LED_LOOP_START_CHASE
#   LED_LOOP_START_BREATH
#   LED_LOOP_START_RAINBOW
#   LED_LOOP_START_TRAIN
# Stop with:
#   LED_LOOP_STOP

[gcode_macro LED_LOOP_CTRL]
variable_running: 0
variable_step: 0
variable_speed_ms: 150
variable_palette: 0   ; 0=NEON,1=PASTEL,2=COOL,3=WARM
variable_mode: 0      ; 0=CHASE,1=BREATH,2=RAINBOW,3=TRAIN
variable_breath_dir: 1
variable_led_count: 3
gcode:
  ; controller state only

[gcode_macro LED_LOOP_START_CHASE]
gcode:
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=mode VALUE=0
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=palette VALUE=0
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE=150
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE=0
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  UPDATE_DELAYED_GCODE ID=led_loop DURATION=0.001

[gcode_macro LED_LOOP_START_BREATH]
gcode:
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=mode VALUE=1
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=palette VALUE=1
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE=80
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE=0
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=breath_dir VALUE=1
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  UPDATE_DELAYED_GCODE ID=led_loop DURATION=0.001

[gcode_macro LED_LOOP_START_RAINBOW]
gcode:
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=mode VALUE=2
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=palette VALUE=2
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE=200
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE=0
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  UPDATE_DELAYED_GCODE ID=led_loop DURATION=0.001

[gcode_macro LED_LOOP_START_TRAIN]
gcode:
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=mode VALUE=3
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=palette VALUE=0
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE=120
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE=0
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  UPDATE_DELAYED_GCODE ID=led_loop DURATION=0.001

[gcode_macro LED_LOOP_STOP]
gcode:
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=0
  BORING_LEDs

[delayed_gcode led_loop]
gcode:
    {% set ctrl = printer['gcode_macro LED_LOOP_CTRL'].variables %}
    {% set running = ctrl.running|int %}
    {% if running == 1 %}
      {% set step = ctrl.step|int %}
      {% set speed = ctrl.speed_ms|int %}
      {% set palette_idx = ctrl.palette|int %}
      {% set mode_idx = ctrl.mode|int %}
      {% set N = ctrl.led_count|default(3)|int %}

      {# --- palette entry selection without lists --- #}
      {# pidx = step % 3, compute via integer division to avoid % operator #}
      {% set plen = 3 %}
      {% set pdiv = step // plen %}
      {% set pidx = step - (pdiv * plen) %}

      {# NEON palette entries #}
      {% if palette_idx == 0 %}
        {% if pidx == 0 %}
          {% set r_val = 1.0 %}{% set g_val = 0.0 %}{% set b_val = 1.0 %}{% set w_val = 0.0 %}
        {% elif pidx == 1 %}
          {% set r_val = 1.0 %}{% set g_val = 0.2 %}{% set b_val = 0.0 %}{% set w_val = 0.0 %}
        {% else %}
          {% set r_val = 0.0 %}{% set g_val = 1.0 %}{% set b_val = 0.2 %}{% set w_val = 0.0 %}
        {% endif %}

      {# PASTEL palette #}
      {% elif palette_idx == 1 %}
        {% if pidx == 0 %}
          {% set r_val = 1.0 %}{% set g_val = 0.8 %}{% set b_val = 0.9 %}{% set w_val = 0.0 %}
        {% elif pidx == 1 %}
          {% set r_val = 0.8 %}{% set g_val = 1.0 %}{% set b_val = 0.9 %}{% set w_val = 0.0 %}
        {% else %}
          {% set r_val = 0.9 %}{% set g_val = 0.9 %}{% set b_val = 1.0 %}{% set w_val = 0.0 %}
        {% endif %}

      {# COOL palette #}
      {% elif palette_idx == 2 %}
        {% if pidx == 0 %}
          {% set r_val = 0.0 %}{% set g_val = 0.6 %}{% set b_val = 1.0 %}{% set w_val = 0.0 %}
        {% elif pidx == 1 %}
          {% set r_val = 0.0 %}{% set g_val = 1.0 %}{% set b_val = 1.0 %}{% set w_val = 0.0 %}
        {% else %}
          {% set r_val = 0.0 %}{% set g_val = 0.5 %}{% set b_val = 0.8 %}{% set w_val = 0.0 %}
        {% endif %}

      {# WARM palette #}
      {% elif palette_idx == 3 %}
        {% if pidx == 0 %}
          {% set r_val = 1.0 %}{% set g_val = 0.5 %}{% set b_val = 0.0 %}{% set w_val = 0.0 %}
        {% elif pidx == 1 %}
          {% set r_val = 1.0 %}{% set g_val = 0.7 %}{% set b_val = 0.2 %}{% set w_val = 0.0 %}
        {% else %}
          {% set r_val = 1.0 %}{% set g_val = 0.3 %}{% set b_val = 0.0 %}{% set w_val = 0.0 %}
        {% endif %}

      {% else %}
        {% set r_val = 1.0 %}{% set g_val = 0.0 %}{% set b_val = 1.0 %}{% set w_val = 0.0 %}
      {% endif %}

      {# --- modes --- #}
      {% if mode_idx == 0 %}
        {# CHASE: compute idx = (step % N) + 1 without % operator #}
        {% set div = step // N %}
        {% set rem = step - (div * N) %}
        {% set idx = rem + 1 %}
        {% for i in range(1, N+1) %}
          {% if i == idx %}
            {{ "SET_LED LED=sb_leds INDEX=" ~ i|string ~ " RED=" ~ (r_val|round(3)|string) ~ " GREEN=" ~ (g_val|round(3)|string) ~ " BLUE=" ~ (b_val|round(3)|string) ~ " WHITE=" ~ (w_val|round(3)|string) }}
          {% else %}
            {{ "SET_LED LED=sb_leds INDEX=" ~ i|string ~ " RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000" }}
          {% endif %}
        {% endfor %}
        {% set next_step = step + 1 %}

      {% elif mode_idx == 1 %}
        {# BREATH: scale base color across 0..1 (step 0..100) #}
        {% set i_val = step %}
        {% set scale = (i_val / 100.0) %}
        {% set rr = (scale * r_val) %}
        {% set gg = (scale * g_val) %}
        {% set bb = (scale * b_val) %}
        {% set ww = (scale * w_val) %}
        {% for iidx in range(1, N+1) %}
          {{ "SET_LED LED=sb_leds INDEX=" ~ iidx|string ~ " RED=" ~ (rr|round(3)|string) ~ " GREEN=" ~ (gg|round(3)|string) ~ " BLUE=" ~ (bb|round(3)|string) ~ " WHITE=" ~ (ww|round(3)|string) }}
        {% endfor %}
        {% set step_inc = 5 %}
        {% if ctrl.breath_dir|default(1)|int == 1 %}
          {% set cand = step + step_inc %}
          {% if cand > 100 %}
            {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=breath_dir VALUE=-1" }}
            {% set next_step = 100 %}
          {% else %}
            {% set next_step = cand %}
          {% endif %}
        {% else %}
          {% set cand = step - step_inc %}
          {% if cand < 0 %}
            {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=breath_dir VALUE=1" }}
            {% set next_step = 0 %}
          {% else %}
            {% set next_step = cand %}
          {% endif %}
        {% endif %}

      {% elif mode_idx == 2 %}
        {# RAINBOW: same color to all LEDs (cycles through pidx) #}
        {% for iidx in range(1, N+1) %}
          {{ "SET_LED LED=sb_leds INDEX=" ~ iidx|string ~ " RED=" ~ (r_val|round(3)|string) ~ " GREEN=" ~ (g_val|round(3)|string) ~ " BLUE=" ~ (b_val|round(3)|string) ~ " WHITE=" ~ (w_val|round(3)|string) }}
        {% endfor %}
        {% set next_step = step + 1 %}

      {% elif mode_idx == 3 %}
        {# TRAIN: head and one trailing dim LED #}
        {% set divh = step // N %}
        {% set remh = step - (divh * N) %}
        {% set head = remh + 1 %}
        {% if head < N %}
          {% set head_next = head + 1 %}
        {% else %}
          {% set head_next = 1 %}
        {% endif %}
        {% for iidx in range(1, N+1) %}
          {% if iidx == head %}
            {{ "SET_LED LED=sb_leds INDEX=" ~ iidx|string ~ " RED=" ~ (r_val|round(3)|string) ~ " GREEN=" ~ (g_val|round(3)|string) ~ " BLUE=" ~ (b_val|round(3)|string) ~ " WHITE=" ~ (w_val|round(3)|string) }}
          {% elif iidx == head_next %}
            {{ "SET_LED LED=sb_leds INDEX=" ~ iidx|string ~ " RED=" ~ ((r_val*0.5)|round(3)|string) ~ " GREEN=" ~ ((g_val*0.5)|round(3)|string) ~ " BLUE=" ~ ((b_val*0.5)|round(3)|string) ~ " WHITE=" ~ ((w_val*0.5)|round(3)|string) }}
          {% else %}
            {{ "SET_LED LED=sb_leds INDEX=" ~ iidx|string ~ " RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000" }}
          {% endif %}
        {% endfor %}
        {% set next_step = step + 1 %}

      {% else %}
        {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=0" }}
        {% set next_step = step %}
      {% endif %}

      {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE=" ~ next_step|string }}
      {% set dur_s = (speed / 1000.0) %}
      {% if dur_s < 0.02 %}
        {% set dur_s = 0.02 %}
      {% endif %}
      {{ "UPDATE_DELAYED_GCODE ID=led_loop DURATION=" ~ (dur_s|round(3)|string) }}
    {% endif %}