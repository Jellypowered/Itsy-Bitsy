[delayed_gcode PRETTY_LEDs]
initial_duration: 1
gcode:
    SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=0.0 BLUE=1.0 WHITE=0.0
    SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=1.0
    SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=1.0

[gcode_macro BORING_LEDs]
gcode:
    SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0 #Anthead Logo LED
    SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0 #Left Nozzle LED
    SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0 #Right Nozzle LED

# Non-blocking LED loop controller (numeric-backed) with CHASE, BREATH, RAINBOW, TRAIN.
# Start examples:
#   LED_LOOP_START MODE=CHASE SPEED_MS=150 PALETTE=NEON
#   LED_LOOP_STOP

[gcode_macro LED_LOOP_CTRL]
# numeric state variables only
variable_running: 0
variable_step: 0
variable_speed_ms: 150
variable_palette: 0   ; 0=NEON,1=PASTEL,2=COOL,3=WARM
variable_mode: 0      ; 0=CHASE,1=BREATH,2=RAINBOW,3=TRAIN
variable_breath_dir: 1
variable_led_count: 3
gcode:
  ; controller state container

[gcode_macro LED_LOOP_START]
# Optional params: MODE=CHASE|BREATH|RAINBOW|TRAIN, SPEED_MS=<ms>, PALETTE=NEON|PASTEL|COOL|WARM
gcode:
    {% set m = params.MODE|default('CHASE')|upper %}
    {% if m == 'CHASE' %}
      {% set mnum = 0 %}
    {% elif m == 'BREATH' %}
      {% set mnum = 1 %}
    {% elif m == 'RAINBOW' %}
      {% set mnum = 2 %}
    {% elif m == 'TRAIN' %}
      {% set mnum = 3 %}
    {% else %}
      {% set mnum = 0 %}
    {% endif %}

    {% set p = params.PALETTE|default('NEON')|upper %}
    {% if p == 'NEON' %}
      {% set pnum = 0 %}
    {% elif p == 'PASTEL' %}
      {% set pnum = 1 %}
    {% elif p == 'COOL' %}
      {% set pnum = 2 %}
    {% elif p == 'WARM' %}
      {% set pnum = 3 %}
    {% else %}
      {% set pnum = 0 %}
    {% endif %}

    {% set speed = params.SPEED_MS|default(150)|int %}

    {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=mode VALUE=%d" % mnum }}
    {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=palette VALUE=%d" % pnum }}
    {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE=%d" % speed }}
    {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE=0" }}
    {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1" }}
    UPDATE_DELAYED_GCODE ID=led_loop DURATION=0.001

[gcode_macro LED_LOOP_STOP]
gcode:
    {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=0" }}
    # restore your normal LEDs macro (match the name in your config)
    BORING_LEDs

[delayed_gcode led_loop]
gcode:
    {% set ctrl = printer['gcode_macro LED_LOOP_CTRL'].variables %}
    {% set running = ctrl.running|int %}
    {% set step = ctrl.step|int %}
    {% set speed = ctrl.speed_ms|int %}
    {% set palette_idx = ctrl.palette|int %}
    {% set mode_idx = ctrl.mode|int %}
    {% set N = ctrl.led_count|default(3)|int %}

    {# map palette index to arrays #}
    {% if palette_idx == 0 %}
      {% set palette = [
        [1.0,0.0,1.0,0.0],
        [1.0,0.2,0.0,0.0],
        [0.0,1.0,0.2,0.0]
      ] %}
    {% elif palette_idx == 1 %}
      {% set palette = [
        [1.0,0.8,0.9,0.0],
        [0.8,1.0,0.9,0.0],
        [0.9,0.9,1.0,0.0]
      ] %}
    {% elif palette_idx == 2 %}
      {% set palette = [
        [0.0,0.6,1.0,0.0],
        [0.0,1.0,1.0,0.0],
        [0.0,0.5,0.8,0.0]
      ] %}
    {% elif palette_idx == 3 %}
      {% set palette = [
        [1.0,0.5,0.0,0.0],
        [1.0,0.7,0.2,0.0],
        [1.0,0.3,0.0,0.0]
      ] %}
    {% else %}
      {% set palette = [
        [1.0,0.0,1.0,0.0],
        [0.0,1.0,1.0,0.0],
        [1.0,1.0,0.0,0.0]
      ] %}
    {% endif %}

    {% if running == 1 %}

      {% if mode_idx == 0 %}
        {# CHASE: one LED on at a time, color cycles through palette #}
        {% set idx = (step % N) + 1 %}
        {% set col = palette[ step % (palette|length) ] %}
        {% set r = col[0] %}
        {% set g = col[1] %}
        {% set b = col[2] %}
        {% set w = col[3] %}
        {% for i in range(1, N+1) %}
          {% if i == idx %}
            {{ "SET_LED LED=sb_leds INDEX=%d RED=%0.3f GREEN=%0.3f BLUE=%0.3f WHITE=%0.3f" % (i, r, g, b, w) }}
          {% else %}
            {{ "SET_LED LED=sb_leds INDEX=%d RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000" % i }}
          {% endif %}
        {% endfor %}
        {% set next_step = step + 1 %}

      {% elif mode_idx == 1 %}
        {# BREATH: smooth ramp on all LEDs; step range 0..100; breath_dir toggles #}
        {% set dir = ctrl.breath_dir|default(1)|int %}
        {% set i_val = step %}
        {% set scale = (i_val / 100.0) %}
        {% set base = palette[0] %}
        {% set r = (scale * base[0]) %}
        {% set g = (scale * base[1]) %}
        {% set b = (scale * base[2]) %}
        {% set w = (scale * base[3]) %}
        {% for iidx in range(1, N+1) %}
          {{ "SET_LED LED=sb_leds INDEX=%d RED=%0.3f GREEN=%0.3f BLUE=%0.3f WHITE=%0.3f" % (iidx, r, g, b, w) }}
        {% endfor %}
        {% set step_inc = 5 %}
        {% if dir == 1 %}
          {% set cand = step + step_inc %}
          {% if cand > 100 %}
            {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=breath_dir VALUE=-1" }}
            {% set next_step = 100 %}
          {% else %}
            {% set next_step = cand %}
          {% endif %}
        {% else %}
          {% set cand = step - step_inc %}
          {% if cand < 0 %}
            {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=breath_dir VALUE=1" }}
            {% set next_step = 0 %}
          {% else %}
            {% set next_step = cand %}
          {% endif %}
        {% endif %}

      {% elif mode_idx == 2 %}
        {# RAINBOW: cycle palette on all LEDs #}
        {% set col = palette[ step % (palette|length) ] %}
        {% set r = col[0] %}
        {% set g = col[1] %}
        {% set b = col[2] %}
        {% set w = col[3] %}
        {% for iidx in range(1, N+1) %}
          {{ "SET_LED LED=sb_leds INDEX=%d RED=%0.3f GREEN=%0.3f BLUE=%0.3f WHITE=%0.3f" % (iidx, r, g, b, w) }}
        {% endfor %}
        {% set next_step = step + 1 %}

      {% elif mode_idx == 3 %}
        {# TRAIN: head with a short trailing dim LED #}
        {% set head = (step % N) + 1 %}
        {% set col = palette[ step % (palette|length) ] %}
        {% set r_h = col[0] %}
        {% set g_h = col[1] %}
        {% set b_h = col[2] %}
        {% set w_h = col[3] %}
        {% for iidx in range(1, N+1) %}
          {% if iidx == head %}
            {{ "SET_LED LED=sb_leds INDEX=%d RED=%0.3f GREEN=%0.3f BLUE=%0.3f WHITE=%0.3f" % (iidx, r_h, g_h, b_h, w_h) }}
          {% elif iidx == ((head % N) + 1) %}
            {{ "SET_LED LED=sb_leds INDEX=%d RED=%0.3f GREEN=%0.3f BLUE=%0.3f WHITE=%0.3f" % (iidx, r_h*0.5, g_h*0.5, b_h*0.5, w_h*0.5) }}
          {% else %}
            {{ "SET_LED LED=sb_leds INDEX=%d RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000" % iidx }}
          {% endif %}
        {% endfor %}
        {% set next_step = step + 1 %}

      {% else %}
        {# unknown mode - stop #}
        {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=0" }}
        {% set next_step = step %}
      {% endif %}

      {# persist next step (# uses Jinja formatting to emit a literal numeric assignment) #}
      {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE=%d" % next_step }}

      {# schedule next run; compute seconds and emit concrete UPDATE_DELAYED_GCODE #}
      {% set dur_s = (speed / 1000.0) %}
      {% if dur_s < 0.02 %}
        {% set dur_s = 0.02 %}
      {% endif %}
      {{ "UPDATE_DELAYED_GCODE ID=led_loop DURATION=%0.3f" % dur_s }}

    {% else %}
      ; loop stopped - nothing to schedule
    {% endif %}