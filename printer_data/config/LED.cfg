[delayed_gcode PRETTY_LEDs]
initial_duration: 1
gcode:
    SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=0.0 BLUE=1.0 WHITE=0.0
    SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=1.0
    SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=1.0

[gcode_macro BORING_LEDs]
gcode:
    SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0 #Anthead Logo LED
    SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0 #Left Nozzle LED
    SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0 #Right Nozzle LED

# Safe LED effects (no risky template constructs). 
# Supports: CHASE (smooth fade), BREATH, RAINBOW, TRAIN
#
# Usage (examples):
#   LED_LOOP_START MODE=CHASE SPEED_MS=40
#   LED_LOOP_START MODE=BREATH SPEED_MS=120
#   LED_LOOP_STOP

[gcode_macro LED_LOOP_CTRL]
# controller state (numeric only)
variable_running: 0
variable_speed_ms: 120
variable_fade_steps: 5
variable_led_count: 3

# per-effect state variables (must be declared so SET_GCODE_VARIABLE can set them)
variable_breath_step: 0
variable_rain_step: 0
variable_train_step: 0
variable_fade_index: 0

gcode:
  ; controller state container

[gcode_macro LED_LOOP_STOP]
gcode:
  # stop loop and restore BORING_LEDs, wait for buffer to clear
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=0
  BORING_LEDs
  M400

[gcode_macro LED_LOOP_START]
# Unified start macro (safe mapping). MODE is a word: CHASE, BREATH, RAINBOW, TRAIN
# SPEED_MS optional (default set below)
gcode:
    {% set mode = params.MODE|default('CHASE')|upper %}
    {% set speed = params.SPEED_MS|default(120)|int %}
    # set speed variable
    SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE={speed}
    # start the requested mode by invoking its start macro (plain G-code line emitted)
    {% if mode == 'CHASE' %}
    LED_LOOP_START_CHASE
    {% elif mode == 'BREATH' %}
    LED_LOOP_START_BREATH
    {% elif mode == 'RAINBOW' %}
    LED_LOOP_START_RAINBOW
    {% elif mode == 'TRAIN' %}
    LED_LOOP_START_TRAIN
    {% else %}
    # fallback to CHASE
    LED_LOOP_START_CHASE
    {% endif %}

#
# START macros (plain-gcode starters). These set running=1 and schedule the first delayed_gcode step.
#
[gcode_macro LED_LOOP_START_CHASE]
gcode:
  # configure fade steps if you want to change from default
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=fade_steps VALUE=5
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  UPDATE_DELAYED_GCODE ID=led_chase_f0 DURATION=0.001

[gcode_macro LED_LOOP_START_BREATH]
gcode:
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  # breath starts from low
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=breath_step VALUE=0
  UPDATE_DELAYED_GCODE ID=led_breath_0 DURATION=0.001

[gcode_macro LED_LOOP_START_RAINBOW]
gcode:
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=rain_step VALUE=0
  UPDATE_DELAYED_GCODE ID=led_rainbow_f0 DURATION=0.001

# --- Change the train starter to a slower default (you can override with SPEED_MS param) ---
[gcode_macro LED_LOOP_START_TRAIN]
gcode:
  # slower default so it looks like a train by default
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE=300
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
  SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=train_step VALUE=0
  UPDATE_DELAYED_GCODE ID=led_train_0 DURATION=0.001

#
# CHASE (smooth) implementation â€” fade between LED indices using fade_steps per transition.
# Structure: led_chase_f0 ... led_chase_f{(N*fade_steps)-1}
# We implement a small, deterministic scheme so templates remain simple and safe:
#
# Behavior (for 3 LEDs, fade_steps=5):
# - Sequence covers LED1 -> LED2 (5 substeps), LED2 -> LED3 (5), LED3 -> LED1 (5), repeat.
#
# Each delayed_gcode template checks running|int first and bails out early if stopped.
#

# We generate N * fade_steps templates (N=3, fade_steps=5 -> 15 templates).
# To keep the config readable and maintainable here we unroll them explicitly for fade_steps=5, N=3.

[delayed_gcode led_chase_f0]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED1 -> LED2, substep 1 (fade_steps=5)
  # brightness fractions: step 1 -> 0.2 / 0.8
  SET_LED LED=sb_leds INDEX=1 RED=0.800 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f1 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f1]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED1 -> LED2, substep 2 (40%)
  SET_LED LED=sb_leds INDEX=1 RED=0.600 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.400 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f2 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f2]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED1 -> LED2, substep 3 (60%)
  SET_LED LED=sb_leds INDEX=1 RED=0.400 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.600 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f3 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f3]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED1 -> LED2, substep 4 (80%)
  SET_LED LED=sb_leds INDEX=1 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.800 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f4 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f4]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED1 -> LED2, substep 5 (100% -> LED2)
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=1.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f5 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f5]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED2 -> LED3, substep 1
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.800 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f6 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f6]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED2 -> LED3, substep 2
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.600 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.400 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f7 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f7]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED2 -> LED3, substep 3
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.400 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.600 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f8 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f8]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED2 -> LED3, substep 4
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.800 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f9 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f9]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED2 -> LED3, substep 5 (100% LED3)
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=1.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f10 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f10]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED3 -> LED1, substep 1
  SET_LED LED=sb_leds INDEX=1 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.800 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f11 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f11]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED3 -> LED1, substep 2
  SET_LED LED=sb_leds INDEX=1 RED=0.400 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.600 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f12 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f12]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED3 -> LED1, substep 3
  SET_LED LED=sb_leds INDEX=1 RED=0.600 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.400 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f13 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f13]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED3 -> LED1, substep 4
  SET_LED LED=sb_leds INDEX=1 RED=0.800 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.200 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_chase_f14 DURATION=0.040
  {% endif %}

[delayed_gcode led_chase_f14]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # transition LED3 -> LED1, substep 5 (back to LED1 full)
  SET_LED LED=sb_leds INDEX=1 RED=1.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=0.0 BLUE=0.0 WHITE=0.0
  # loop back to first fade substep
  UPDATE_DELAYED_GCODE ID=led_chase_f0 DURATION=0.040
  {% endif %}

# --- BREATH: smooth ramp up and down (safe chain) ---
# (Uses magenta/orange/green-ish pallets similar to prior demos; you can change colors)
[delayed_gcode led_breath_0]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # breath 0 (low)
  SET_LED LED=sb_leds INDEX=1 RED=0.05 GREEN=0.00 BLUE=0.10 WHITE=0.00
  SET_LED LED=sb_leds INDEX=2 RED=0.05 GREEN=0.00 BLUE=0.05 WHITE=0.00
  SET_LED LED=sb_leds INDEX=3 RED=0.05 GREEN=0.05 BLUE=0.00 WHITE=0.00
  UPDATE_DELAYED_GCODE ID=led_breath_1 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_breath_1]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # breath 1
  SET_LED LED=sb_leds INDEX=1 RED=0.15 GREEN=0.00 BLUE=0.30 WHITE=0.00
  SET_LED LED=sb_leds INDEX=2 RED=0.15 GREEN=0.00 BLUE=0.15 WHITE=0.00
  SET_LED LED=sb_leds INDEX=3 RED=0.15 GREEN=0.15 BLUE=0.00 WHITE=0.00
  UPDATE_DELAYED_GCODE ID=led_breath_2 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_breath_2]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # breath 2
  SET_LED LED=sb_leds INDEX=1 RED=0.30 GREEN=0.00 BLUE=0.60 WHITE=0.00
  SET_LED LED=sb_leds INDEX=2 RED=0.30 GREEN=0.00 BLUE=0.30 WHITE=0.00
  SET_LED LED=sb_leds INDEX=3 RED=0.30 GREEN=0.30 BLUE=0.00 WHITE=0.00
  UPDATE_DELAYED_GCODE ID=led_breath_3 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_breath_3]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # breath 3 (peak)
  SET_LED LED=sb_leds INDEX=1 RED=0.60 GREEN=0.00 BLUE=1.00 WHITE=0.00
  SET_LED LED=sb_leds INDEX=2 RED=0.60 GREEN=0.00 BLUE=0.60 WHITE=0.00
  SET_LED LED=sb_leds INDEX=3 RED=0.60 GREEN=0.60 BLUE=0.00 WHITE=0.00
  UPDATE_DELAYED_GCODE ID=led_breath_4 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_breath_4]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # breath 4 (top)
  SET_LED LED=sb_leds INDEX=1 RED=1.00 GREEN=0.00 BLUE=1.00 WHITE=0.00
  SET_LED LED=sb_leds INDEX=2 RED=1.00 GREEN=0.00 BLUE=1.00 WHITE=0.00
  SET_LED LED=sb_leds INDEX=3 RED=1.00 GREEN=1.00 BLUE=0.00 WHITE=0.00
  UPDATE_DELAYED_GCODE ID=led_breath_5 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_breath_5]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # breath 5 (fade down step 1)
  SET_LED LED=sb_leds INDEX=1 RED=0.60 GREEN=0.00 BLUE=1.00 WHITE=0.00
  SET_LED LED=sb_leds INDEX=2 RED=0.60 GREEN=0.00 BLUE=0.60 WHITE=0.00
  SET_LED LED=sb_leds INDEX=3 RED=0.60 GREEN=0.60 BLUE=0.00 WHITE=0.00
  UPDATE_DELAYED_GCODE ID=led_breath_6 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_breath_6]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # breath 6 (fade down 2)
  SET_LED LED=sb_leds INDEX=1 RED=0.30 GREEN=0.00 BLUE=0.60 WHITE=0.00
  SET_LED LED=sb_leds INDEX=2 RED=0.30 GREEN=0.00 BLUE=0.30 WHITE=0.00
  SET_LED LED=sb_leds INDEX=3 RED=0.30 GREEN=0.30 BLUE=0.00 WHITE=0.00
  UPDATE_DELAYED_GCODE ID=led_breath_7 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_breath_7]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # breath 7 (fade down 3)
  SET_LED LED=sb_leds INDEX=1 RED=0.15 GREEN=0.00 BLUE=0.30 WHITE=0.00
  SET_LED LED=sb_leds INDEX=2 RED=0.15 GREEN=0.00 BLUE=0.15 WHITE=0.00
  SET_LED LED=sb_leds INDEX=3 RED=0.15 GREEN=0.15 BLUE=0.00 WHITE=0.00
  UPDATE_DELAYED_GCODE ID=led_breath_8 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_breath_8]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # breath 8 (back to low)
  SET_LED LED=sb_leds INDEX=1 RED=0.05 GREEN=0.00 BLUE=0.10 WHITE=0.00
  SET_LED LED=sb_leds INDEX=2 RED=0.05 GREEN=0.00 BLUE=0.05 WHITE=0.00
  SET_LED LED=sb_leds INDEX=3 RED=0.05 GREEN=0.05 BLUE=0.00 WHITE=0.00
  UPDATE_DELAYED_GCODE ID=led_breath_0 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

# Smooth Rainbow: 3 palette colors with 5 fade substeps each (15 templates total).
# Each template checks running first and reschedules to the next substep.
# Uses speed_ms from LED_LOOP_CTRL for substep timing:
#   LED_LOOP_START MODE=RAINBOW SPEED_MS=40

[delayed_gcode led_rainbow_f0]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # A->B substep 1 (A=magenta, B=green)
  SET_LED LED=sb_leds INDEX=1 RED=0.800 GREEN=0.200 BLUE=0.840 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.800 GREEN=0.200 BLUE=0.840 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.800 GREEN=0.200 BLUE=0.840 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f1 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f1]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # A->B substep 2
  SET_LED LED=sb_leds INDEX=1 RED=0.600 GREEN=0.400 BLUE=0.680 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.600 GREEN=0.400 BLUE=0.680 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.600 GREEN=0.400 BLUE=0.680 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f2 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f2]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # A->B substep 3
  SET_LED LED=sb_leds INDEX=1 RED=0.400 GREEN=0.600 BLUE=0.520 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.400 GREEN=0.600 BLUE=0.520 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.400 GREEN=0.600 BLUE=0.520 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f3 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f3]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # A->B substep 4
  SET_LED LED=sb_leds INDEX=1 RED=0.200 GREEN=0.800 BLUE=0.360 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.200 GREEN=0.800 BLUE=0.360 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.200 GREEN=0.800 BLUE=0.360 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f4 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f4]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # A->B arrive (B = green)
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=1.000 BLUE=0.200 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=1.000 BLUE=0.200 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=1.000 BLUE=0.200 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f5 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f5]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # B->C substep 1 (B=green, C=blue)
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.920 BLUE=0.360 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.920 BLUE=0.360 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=0.920 BLUE=0.360 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f6 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f6]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # B->C substep 2
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.840 BLUE=0.520 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.840 BLUE=0.520 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=0.840 BLUE=0.520 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f7 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f7]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # B->C substep 3
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.760 BLUE=0.680 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.760 BLUE=0.680 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=0.760 BLUE=0.680 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f8 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f8]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # B->C substep 4
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.680 BLUE=0.840 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.680 BLUE=0.840 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=0.680 BLUE=0.840 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f9 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f9]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # B->C arrive (C = blue)
  SET_LED LED=sb_leds INDEX=1 RED=0.000 GREEN=0.600 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.000 GREEN=0.600 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.000 GREEN=0.600 BLUE=1.000 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f10 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f10]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # C->A substep 1 (C=blue, A=magenta)
  SET_LED LED=sb_leds INDEX=1 RED=0.200 GREEN=0.480 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.200 GREEN=0.480 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.200 GREEN=0.480 BLUE=1.000 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f11 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f11]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # C->A substep 2
  SET_LED LED=sb_leds INDEX=1 RED=0.400 GREEN=0.360 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.400 GREEN=0.360 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.400 GREEN=0.360 BLUE=1.000 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f12 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f12]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # C->A substep 3
  SET_LED LED=sb_leds INDEX=1 RED=0.600 GREEN=0.240 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.600 GREEN=0.240 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.600 GREEN=0.240 BLUE=1.000 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f13 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f13]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # C->A substep 4
  SET_LED LED=sb_leds INDEX=1 RED=0.800 GREEN=0.120 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=0.800 GREEN=0.120 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=0.800 GREEN=0.120 BLUE=1.000 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f14 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_rainbow_f14]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  # C->A arrive (A = magenta)
  SET_LED LED=sb_leds INDEX=1 RED=1.000 GREEN=0.000 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=2 RED=1.000 GREEN=0.000 BLUE=1.000 WHITE=0.000
  SET_LED LED=sb_leds INDEX=3 RED=1.000 GREEN=0.000 BLUE=1.000 WHITE=0.000
  UPDATE_DELAYED_GCODE ID=led_rainbow_f0 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

# --- TRAIN chain remains but will use speed_ms for delay; default start sets speed_ms=300 ---
[delayed_gcode led_train_0]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.5 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.2 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_1 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_train_1]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=0.2 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=1.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=0.5 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_2 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}

[delayed_gcode led_train_2]
gcode:
  {% if printer['gcode_macro LED_LOOP_CTRL'].running|int == 1 %}
  SET_LED LED=sb_leds INDEX=1 RED=0.5 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=2 RED=0.2 GREEN=0.0 BLUE=0.0 WHITE=0.0
  SET_LED LED=sb_leds INDEX=3 RED=1.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
  UPDATE_DELAYED_GCODE ID=led_train_0 DURATION={printer['gcode_macro LED_LOOP_CTRL'].speed_ms|int / 1000.0}
  {% endif %}