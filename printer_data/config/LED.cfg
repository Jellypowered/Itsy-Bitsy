[delayed_gcode PRETTY_LEDs]
initial_duration: 1
gcode:
    SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=0.0 BLUE=1.0 WHITE=0.0
    SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=1.0
    SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=1.0

[gcode_macro BORING_LEDs]
gcode:
    SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0 #Anthead Logo LED
    SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0 #Left Nozzle LED
    SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0 #Right Nozzle LED

# Non-blocking repeating LED loop using delayed_gcode.
# Usage:
#  LED_LOOP_START SPEED_MS=150 PALETTE=NEON
#  LED_LOOP_STOP

[gcode_macro LED_LOOP_CTRL]
# storage for loop state (accessed/updated by the delayed_gcode)
variable_running: 0
variable_step: 0
variable_speed_ms: 150   ; default step delay in milliseconds
variable_palette: NEON   ; string label; changed by LED_LOOP_START if provided
gcode:
  # controller macro: variables are read/modified by other macros/delayed_gcode

[gcode_macro LED_LOOP_START]
# Start the LED loop. Optional params:
#   SPEED_MS=<ms>  (step duration, default 150)
#   PALETTE=<name> (NEON / PASTEL / COOL / WARM)
gcode:
    {% set speed = params.SPEED_MS|default(150)|int %}
    {% set pal = params.PALETTE|default('NEON')|string %}
    # set controller variables
    SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE={speed}
    SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=palette VALUE={pal}
    SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE=0
    SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
    # schedule the delayed_gcode to run immediately (first step)
    UPDATE_DELAYED_GCODE ID=led_loop DURATION=0.001

[gcode_macro LED_LOOP_STOP]
# Stop the LED loop and restore BORING_LEDs (or turn off).
gcode:
    SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=0
    # optional: set a neutral state or call your BORING_LEDs macro:
    BORING_LEDs

[delayed_gcode led_loop]
gcode:
    {# Read controller variables from the LED_LOOP_CTRL macro #}
    {% set ctrl = printer['gcode_macro LED_LOOP_CTRL'].variables %}
    {% set running = ctrl.running|int %}
    {% set step = ctrl.step|int %}
    {% set speed = ctrl.speed_ms|int %}
    {% set pal_name = (ctrl.palette|string).upper() %}

    {# Pick palette by name (expand or change palettes here) #}
    {% if pal_name == 'NEON' %}
      {% set palette = [
        [1.0,0.0,1.0,0.0],  # magenta neon
        [1.0,0.2,0.0,0.0],  # orange neon
        [0.0,1.0,0.2,0.0]   # green neon
      ] %}
    {% elif pal_name == 'PASTEL' %}
      {% set palette = [
        [1.0,0.8,0.9,0.0],
        [0.8,1.0,0.9,0.0],
        [0.9,0.9,1.0,0.0]
      ] %}
    {% elif pal_name == 'COOL' %}
      {% set palette = [
        [0.0,0.6,1.0,0.0],
        [0.0,1.0,1.0,0.0],
        [0.0,0.5,0.8,0.0]
      ] %}
    {% elif pal_name == 'WARM' %}
      {% set palette = [
        [1.0,0.5,0.0,0.0],
        [1.0,0.7,0.2,0.0],
        [1.0,0.3,0.0,0.0]
      ] %}
    {% else %}
      {% set palette = [
        [1.0,0.0,1.0,0.0],
        [0.0,1.0,1.0,0.0],
        [1.0,1.0,0.0,0.0]
      ] %}
    {% endif %}

    {% if running == 1 %}
      {# compute color for this step (choose which LED index to light, or set all) #}
      {% set col = palette[ step % (palette|length) ] %}
      {% set r = col[0] %}
      {% set g = col[1] %}
      {% set b = col[2] %}
      {% set w = col[3] %}

      {# Emit concrete SET_LED lines (Jinja renders the numbers: no leftover {{ }} or { } tokens) #}
      {{ "SET_LED LED=sb_leds INDEX=1 RED=%0.3f GREEN=%0.3f BLUE=%0.3f WHITE=%0.3f" % (r, g, b, w) }}
      {{ "SET_LED LED=sb_leds INDEX=2 RED=%0.3f GREEN=%0.3f BLUE=%0.3f WHITE=%0.3f" % (r, g, b, w) }}
      {{ "SET_LED LED=sb_leds INDEX=3 RED=%0.3f GREEN=%0.3f BLUE=%0.3f WHITE=%0.3f" % (r, g, b, w) }}

      {# increment step counter (emit literal numeric via Jinja) #}
      {% set next_step = (step + 1) %}
      {{ "SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE=%d" % next_step }}

      {# reschedule next run using the configured speed (ms -> seconds) #}
      {% set dur = (speed / 1000.0) %}
      {{ "UPDATE_DELAYED_GCODE ID=led_loop DURATION=%0.3f" % dur }}
    {% else %}
      {# If not running: optionally clear LED or do nothing. No reschedule. #}
    {% endif %}