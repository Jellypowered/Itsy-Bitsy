[delayed_gcode PRETTY_LEDs]
initial_duration: 1
gcode:
    SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=0.0 BLUE=1.0 WHITE=0.0
    SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=1.0
    SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=1.0

[gcode_macro BORING_LEDs]
gcode:
    SET_LED LED=sb_leds INDEX=1 RED=1.0 GREEN=1.0 BLUE=0.0 WHITE=0.0 #Anthead Logo LED
    SET_LED LED=sb_leds INDEX=2 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0 #Left Nozzle LED
    SET_LED LED=sb_leds INDEX=3 RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0 #Right Nozzle LED

# Non-blocking LED loop controller with multiple modes: CHASE, BREATH, RAINBOW, TRAIN
# Start: LED_LOOP_START MODE=CHASE SPEED_MS=150 PALETTE=NEON
# Stop:  LED_LOOP_STOP

[gcode_macro LED_LOOP_CTRL]
# state variables (use simple literals; strings are quoted)
variable_running: 0
variable_step: 0
variable_speed_ms: 150
variable_palette: "NEON"
variable_mode: "CHASE"
variable_breath_dir: 1
variable_led_count: 3
gcode:
  ; controller state container

[gcode_macro LED_LOOP_START]
# Optional params: MODE=CHASE|BREATH|RAINBOW|TRAIN, SPEED_MS=<ms>, PALETTE=<NEON|PASTEL|COOL|WARM>
gcode:
    {% set mode = params.MODE|default('CHASE')|upper %}
    {% set speed = params.SPEED_MS|default(150)|int %}
    {% set pal = params.PALETTE|default('NEON')|upper %}
    # Quote string values so Klipper parses them correctly
    SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=mode VALUE="{mode}"
    SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=speed_ms VALUE={speed}
    SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=palette VALUE="{pal}"
    SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE=0
    SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=1
    UPDATE_DELAYED_GCODE ID=led_loop DURATION=0.001

[gcode_macro LED_LOOP_STOP]
gcode:
    SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=0
    # restore your normal LEDs; ensure name matches your macro
    BORING_LEDs

[delayed_gcode led_loop]
gcode:
    {% set ctrl = printer['gcode_macro LED_LOOP_CTRL'].variables %}
    {% set running = ctrl.running|int %}
    {% set step = ctrl.step|int %}
    {% set speed = ctrl.speed_ms|int %}
    {% set pal_name = ctrl.palette|default('NEON')|string|upper %}
    {% set mode = ctrl.mode|default('CHASE')|string|upper %}
    {% set N = ctrl.led_count|default(3)|int %}

    {% if pal_name == 'NEON' %}
      {% set palette = [
        [1.0,0.0,1.0,0.0],
        [1.0,0.2,0.0,0.0],
        [0.0,1.0,0.2,0.0]
      ] %}
    {% elif pal_name == 'PASTEL' %}
      {% set palette = [
        [1.0,0.8,0.9,0.0],
        [0.8,1.0,0.9,0.0],
        [0.9,0.9,1.0,0.0]
      ] %}
    {% elif pal_name == 'COOL' %}
      {% set palette = [
        [0.0,0.6,1.0,0.0],
        [0.0,1.0,1.0,0.0],
        [0.0,0.5,0.8,0.0]
      ] %}
    {% elif pal_name == 'WARM' %}
      {% set palette = [
        [1.0,0.5,0.0,0.0],
        [1.0,0.7,0.2,0.0],
        [1.0,0.3,0.0,0.0]
      ] %}
    {% else %}
      {% set palette = [
        [1.0,0.0,1.0,0.0],
        [0.0,1.0,1.0,0.0],
        [1.0,1.0,0.0,0.0]
      ] %}
    {% endif %}

    {% if running == 1 %}
      {% if mode == 'CHASE' %}
        {% set idx = (step % N) + 1 %}
        {% set col = palette[ step % (palette|length) ] %}
        {% set r = col[0] %}
        {% set g = col[1] %}
        {% set b = col[2] %}
        {% set w = col[3] %}
        {% for i in range(1, N+1) %}
          {% if i == idx %}
            SET_LED LED=sb_leds INDEX={i} RED={r} GREEN={g} BLUE={b} WHITE={w}
          {% else %}
            SET_LED LED=sb_leds INDEX={i} RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
          {% endif %}
        {% endfor %}
        {% set next_step = step + 1 %}

      {% elif mode == 'BREATH' %}
        {% set dir = ctrl.breath_dir|default(1)|int %}
        {% set i = step %}
        {% set scale = (i / 100.0) %}
        {% set base = palette[0] %}
        {% set r = (scale * base[0]) | round(3) %}
        {% set g = (scale * base[1]) | round(3) %}
        {% set b = (scale * base[2]) | round(3) %}
        {% set w = (scale * base[3]) | round(3) %}
        {% for iidx in range(1, N+1) %}
          SET_LED LED=sb_leds INDEX={iidx} RED={r} GREEN={g} BLUE={b} WHITE={w}
        {% endfor %}
        {% set step_inc = 5 %}
        {% if dir == 1 %}
          {% set candidate = step + step_inc %}
          {% if candidate > 100 %}
            SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=breath_dir VALUE=-1
            {% set next_step = 100 %}
          {% else %}
            {% set next_step = candidate %}
          {% endif %}
        {% else %}
          {% set candidate = step - step_inc %}
          {% if candidate < 0 %}
            SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=breath_dir VALUE=1
            {% set next_step = 0 %}
          {% else %}
            {% set next_step = candidate %}
          {% endif %}
        {% endif %}

      {% elif mode == 'RAINBOW' %}
        {% set col = palette[ step % (palette|length) ] %}
        {% set r = col[0] %}
        {% set g = col[1] %}
        {% set b = col[2] %}
        {% set w = col[3] %}
        {% for iidx in range(1, N+1) %}
          SET_LED LED=sb_leds INDEX={iidx} RED={r} GREEN={g} BLUE={b} WHITE={w}
        {% endfor %}
        {% set next_step = step + 1 %}

      {% elif mode == 'TRAIN' %}
        {% set head = (step % N) + 1 %}
        {% set col = palette[ step % (palette|length) ] %}
        {% set r_h = col[0] %}
        {% set g_h = col[1] %}
        {% set b_h = col[2] %}
        {% set w_h = col[3] %}
        {% for iidx in range(1, N+1) %}
          {% set dist = (iidx - head) if iidx >= head else (N - head + iidx) %}
          {% if dist == 0 %}
            SET_LED LED=sb_leds INDEX={iidx} RED={r_h} GREEN={g_h} BLUE={b_h} WHITE={w_h}
          {% elif dist == 1 %}
            SET_LED LED=sb_leds INDEX={iidx} RED={r_h*0.5} GREEN={g_h*0.5} BLUE={b_h*0.5} WHITE={w_h*0.5}
          {% else %}
            SET_LED LED=sb_leds INDEX={iidx} RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0
          {% endif %}
        {% endfor %}
        {% set next_step = step + 1 %}

      {% else %}
        BORING_LEds
        SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=running VALUE=0
      {% endif %}

      # persist next step (numeric)
      SET_GCODE_VARIABLE MACRO=LED_LOOP_CTRL VARIABLE=step VALUE={next_step}

      # schedule next run (ms -> seconds), clamp minimum to 20 ms
      {% set dur_s = (speed / 1000.0) %}
      {% if dur_s < 0.02 %}
        {% set dur_s = 0.02 %}
      {% endif %}
      UPDATE_DELAYED_GCODE ID=led_loop DURATION={dur_s}
    {% else %}
      ; loop stopped; nothing to schedule
    {% endif %}